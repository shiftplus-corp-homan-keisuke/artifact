## オンデマンド・アーティファクト表示システム 仕様書

**1. 概要**

本仕様書は、ユーザー提供または LLM 生成によるソースコード（主に Web フロントエンド技術）を、安全な環境でオンデマンドにビルドし、その実行結果を親アプリケーション内の `<iframe>` に動的に表示するシステムの仕様を定義する。主要な通信メカニズムとして `window.postMessage` API を利用し、ビルドプロセスには Vite を活用する。

**2. 目的**

- 信頼できない可能性のあるソースコードを、安全に隔離された環境（`<iframe>` サンドボックス）でプレビューする。
- React/JSX を含む最新のフロントエンドコードを、ユーザー側に追加のビルド環境なしで表示可能にする。
- 親アプリケーションから `<iframe>` 内のコンテンツを動的に更新する仕組みを提供する。
- 複数ユーザーによる同時利用に対応し、それぞれに独立したアーティファクト表示を可能にする。

**3. システム構成**

本システムは以下の 3 つの主要コンポーネントから構成される。

| コンポーネント                   | 種別           | 主要技術 (例)         | 主な役割                                                                                                                                        |
| :------------------------------- | :------------- | :-------------------- | :---------------------------------------------------------------------------------------------------------------------------------------------- |
| **親ウィンドウアプリケーション** | フロントエンド | React, TypeScript     | UI 提供、ビルドリクエスト発行、`iframe` 配置、`iframe` ローダーへの `postMessage` 送信、`iframe` ローダーからのメッセージ受信                   |
| **オンデマンドビルドサービス**   | バックエンド   | Node.js, Docker, Vite | ソースコードを受け付け、隔離環境で Vite ビルドを実行、ビルド成果物（JS バンドル文字列等）を生成して親アプリに返却                               |
| **`iframe` ローダーページ**      | フロントエンド | 静的 HTML, JavaScript | `iframe` の `src` に指定される固定ページ。親からの `postMessage` を受信し、受け取った成果物を解釈・実行してコンテンツを表示、親に準備完了を通知 |

**4. コア機能要件**

- **F-001: ソースコード入力/取得:** 親アプリは、ユーザー入力または LLM からの出力をソースコードとして取得できること。
- **F-002: オンデマンドビルド:** 親アプリは、取得したソースコードをオンデマンドビルドサービスに送信し、ビルドを要求できること。
- **F-003: Vite によるビルド:** ビルドサービスは、受け取ったソースコードを Vite を用いてビルドできること (JSX 変換、依存関係解決、バンドル等)。
- **F-004: 成果物生成:** ビルドサービスは、ブラウザで直接実行可能な成果物（主に単一の JavaScript バンドル文字列）を生成できること。
- **F-005: 成果物返却:** ビルドサービスは、生成した成果物またはエラー情報を親アプリにレスポンスとして返却できること。
- **F-006: `iframe` ローダー読み込み:** 親アプリは、`<iframe>` を表示し、固定 URL の `iframe` ローダーページを読み込めること。
- **F-007: ローダー準備完了通知:** `iframe` ローダーは、自身の初期化完了後、`postMessage` を使用して親アプリに準備完了を通知できること。
- **F-008: `postMessage` による成果物注入:** 親アプリは、ビルドサービスから受け取った成果物を、`postMessage` を使用して準備完了状態の `iframe` ローダーに送信できること。
- **F-009: `iframe` 内レンダリング:** `iframe` ローダーは、親アプリから受信した成果物を解釈し、`<iframe>` 内にコンテンツを動的に表示/実行できること。
- **F-010: セキュリティ - `iframe` サンドボックス:** `iframe` 要素には適切な `sandbox` 属性（`allow-scripts` は必須、他は制限）を設定し、コンテンツを隔離すること。
- **F-011: セキュリティ - オリジンチェック:** 親アプリと `iframe` ローダー間の `postMessage` 通信では、必ず送信元/送信先のオリジンを検証すること。
- **F-012: セキュリティ - ビルド環境隔離:** ビルドサービスは、各ビルドリクエストをコンテナ等の隔離された環境で実行すること。リソース制限を適用すること。
- **F-013: エラーハンドリング:** ビルドエラー、`postMessage` 通信エラー、`iframe` 内実行時エラーなどを適切にハンドリングし、ユーザーまたはログにフィードバックできること。
- **F-014: コンテンツクリーンアップ:** `iframe` ローダーは、新しいコンテンツを表示する前に、以前表示していたコンテンツに関連するリソース（DOM、イベントリスナー等）を可能な限りクリーンアップできること。

**5. コンポーネント詳細仕様**

**5.1. 親ウィンドウアプリケーション**

- **UI:**
  - ソースコード入力エリア (例: `textarea`)
  - ビルド実行ボタン
  - `iframe` 表示エリア
  - ビルドステータス表示 (ビルド中、成功、エラー)
  - エラーメッセージ表示エリア
- **機能:**
  - `iframeRef` を使用して `iframe` 要素への参照を保持。
  - ビルドボタンクリック時に、入力されたソースコードを取得し、ビルドサービス API (`/api/build-artifact`) に POST リクエストを送信。
  - API レスポンスを処理し、成功時は成果物を状態に保持、失敗時はエラーメッセージを表示。
  - `window.addEventListener('message', ...)` で `iframe` ローダーからのメッセージを待ち受ける。
    - `event.origin` を検証。
    - `event.data.type === 'loaderReady'` を受信したら、ローダー準備完了状態を更新。
  - ローダー準備完了かつ成果物がある場合、`iframeRef.current.contentWindow.postMessage(...)` で成果物ペイロードを `iframe` ローダーに送信。送信時には `iframe` ローダーのオリジンを指定。
  - 状態管理 (例: `useState`, `useReducer`) でビルド中フラグ、エラー情報、成果物データ、ローダー準備完了フラグ等を管理。

**5.2. オンデマンドビルドサービス (バックエンド API)**

- **API エンドポイント:** `/api/build-artifact` (POST)
  - **リクエストボディ (JSON):**
    ```json
    {
      "sourceCode": "...", // ビルド対象のソースコード文字列 (必須)
      "dependencies": {
        /* オプション: package.json の dependencies 相当 */
      },
      "viteConfig": {
        /* オプション: Vite設定の一部を上書き */
      }
    }
    ```
  - **レスポンス (成功時 - 200 OK) (JSON):**
    ```json
    {
      "success": true,
      "artifact": {
        "type": "jsBundle", // 成果物の種類 (現時点では jsBundle を想定)
        "content": "..." // ビルドされたJavaScriptコードの文字列
      }
    }
    ```
  - **レスポンス (失敗時 - 400/500) (JSON):**
    ```json
    {
      "success": false,
      "error": "エラーメッセージ詳細"
    }
    ```
- **ビルドプロセス:**
  1.  リクエストを受け付け、入力値を検証。
  2.  隔離された実行環境（推奨: Docker コンテナ）を起動。
  3.  一時的なプロジェクトディレクトリを作成。
  4.  `sourceCode` をファイル (例: `src/main.jsx`) に書き出す。
  5.  `package.json` と `vite.config.js` を生成または配置。
      - `vite.config.js` では、成果物を単一の JS ファイル (IIFE 形式など) にインライン化または出力する設定を行う。React 等のコアライブラリはバンドルするか、ローダーページ側で外部読み込みするか決定する。
  6.  依存関係をインストール (`npm ci` / `yarn install`)。キャッシュ戦略を検討。
  7.  `npx vite build` を実行。
  8.  生成された JS バンドルファイルの内容を読み込み、文字列として取得。
  9.  成功レスポンスを生成して返す。
  10. エラー発生時は、エラー情報をキャッチし、失敗レスポンスを生成して返す。
  11. 実行環境をクリーンアップ（コンテナ破棄）。
- **セキュリティ:**
  - コンテナに厳格なリソース制限（CPU、メモリ、実行時間）、ネットワーク制限を適用。
  - コンテナは非 root ユーザーで実行。

**5.3. `iframe` ローダーページ**

- **ファイル:** `artifact-loader.html` (バージョン管理推奨、例: `artifact-loader-v1.html`)。静的ファイルとして CDN 等で配信。
- **HTML:**
  - 基本的な HTML 構造 (`<!DOCTYPE html>`, `head`, `body`)。
  - コンテンツ描画用のルート要素 (`<div id="artifact-root"></div>`)。
  - 必要に応じて外部ライブラリ（React, ReactDOM, DOMPurify 等）を CDN から読み込む `<script>` タグ。
  - インラインまたは別ファイルの `<script>` で後述の JavaScript ロジックを実装。
- **JavaScript ロジック:**
  - 即時実行関数 (`(function() { ... })();`) でスコープを保護。
  - 許可する親ウィンドウのオリジン (`ALLOWED_PARENT_ORIGIN`) を定数で定義（**重要: 正確に設定**）。
  - `window.addEventListener('message', handleMessage)` でメッセージを待ち受け。
  - `handleMessage` 関数:
    - `event.origin` を `ALLOWED_PARENT_ORIGIN` と比較し、一致しない場合は処理を中断。
    - `event.data.type === 'loadArtifact'` の場合、`loadArtifact` 関数を呼び出す。
  - `loadArtifact` 関数:
    - `cleanupPreviousArtifact` 関数を呼び出して前回のコンテンツをクリア。
    - 受信した `artifact.type` に応じて処理を分岐。
      - `jsBundle`: 受け取った `artifact.content` (JS 文字列) を動的に実行 (例: 新しい `<script>` 要素を作成して追加)。実行後に呼び出すべきクリーンアップ処理があれば `currentCleanup` 関数に設定。
      - `htmlString`: (もし実装する場合) `artifact.content` (HTML 文字列) を **必ず DOMPurify 等でサニタイズ** してから `#artifact-root` に `innerHTML` で設定。
      - `uiJson`: (もし実装する場合) `artifact.content` (JSON オブジェクト) を解釈して DOM 要素または React コンポーネントを生成・描画。
    - エラー発生時は `displayError` 関数でエラーメッセージを表示。
  - `cleanupPreviousArtifact` 関数: `currentCleanup` 関数を実行し、`#artifact-root` の内容をクリア。
  - `displayError` 関数: `#artifact-root` にエラーメッセージを表示。
  - 初期化処理: `message` イベントリスナーを登録。`window.parent.postMessage({ type: 'loaderReady' }, ALLOWED_PARENT_ORIGIN)` を呼び出して親に準備完了を通知。

**6. データフォーマット (JSON スキーマ例)**

- **ビルド API リクエストボディ:** (5.2 参照)
- **ビルド API レスポンス:** (5.2 参照)
- **`postMessage` ペイロード (`loadArtifact`):**
  ```json
  {
    "type": "loadArtifact",
    "artifact": {
      "type": "jsBundle" | "htmlString" | "uiJson", // ビルドサービスが返した型
      "content": "..." | {} // ビルドサービスが返した内容
    }
  }
  ```
- **`postMessage` ペイロード (`loaderReady`):**
  ```json
  {
    "type": "loaderReady"
  }
  ```

**7. 非機能要件 (考慮事項)**

- **パフォーマンス:**
  - ビルド時間: 高速ビルドツール(Vite/esbuild)の利用、依存関係キャッシュ戦略により短縮を図る。
  - `iframe` 表示速度: ローダーページのサイズを最小限にし、成果物 JS のサイズを最適化する。CDN を利用する。
- **スケーラビリティ:** ビルドサービスは、サーバーレスアーキテクチャやコンテナオーケストレーションにより、同時リクエスト数に応じてスケール可能であること。
- **セキュリティ:** 本仕様書で述べた `iframe` サンドボックス、オリジンチェック、ビルド環境隔離、リソース制限、XSS 対策（HTML 注入時）を徹底すること。
- **可用性:** ビルドサービス、ローダーページ配信インフラが高い可用性を持つこと。
- **保守性:** 各コンポーネントのコードは適切に構造化され、テスト可能であること。ローダーページのバージョン管理を行うこと。

**8. 技術スタック (例)**

- **親アプリケーション:** React, TypeScript, CSS Modules/Styled Components
- **ビルドサービス API:** Node.js (Fastify/Express), TypeScript
- **ビルド環境:** Docker, Vite, Node.js
- **インフラ:**
  - コンテナ実行: AWS Fargate / Lambda (Container Image Support), Google Cloud Run
  - API Gateway: AWS API Gateway / Google Cloud Endpoints
  - 静的ファイル配信: AWS S3 + CloudFront / Google Cloud Storage + Cloud CDN
- **その他:** DOMPurify (HTML サニタイズ用)

---

**改訂履歴**

- Ver 1.0 (YYYY-MM-DD): 初版作成
